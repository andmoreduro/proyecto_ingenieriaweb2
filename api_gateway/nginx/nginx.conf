events {}

http {
    # Define the "upstream" services. Docker Compose makes your services
    # available by their service name as a hostname.
    upstream users_service {
        server users_service:8000;
    }

    upstream recipes_service {
        server recipes_service:8000;
    }

    # The main server block that listens for incoming connections.
    server {
        listen 80; # Listen on port 80, which we exposed in docker-compose.

        # --- Routing Rule for Users Service ---
        location /api/user/ {
            # Forward the request to the user_service upstream group
            proxy_pass http://users_service;

            # Set headers to pass along original request info
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }

        # --- Routing Rule for Recipes Service ---
        location /api/recipe/ {
            # Forward the request to the recipe_service upstream group
            proxy_pass http://recipes_service;

            # Set headers
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }

        # This is an internal-only location used by auth_request.
        location /_verify_auth {
            internal; # Prevents users from calling this directly
            proxy_pass http://users_service/api/users/verify-token; # The new endpoint
            proxy_pass_request_body off; # Don't send the original request body
            proxy_set_header Content-Length "";
            proxy_set_header X-Original-URI $request_uri;
            proxy_set_header Authorization $http_authorization;
        }
    }
}
